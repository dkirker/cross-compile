From d90489847b88590e268a420548d02f1f384455d0 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Malte=20Schr=C3=B6der?= <maltesch@gmx.de>
Date: Thu, 6 Jan 2011 19:41:33 +0100
Subject: [PATCH 1/4] apply-development-changes

---
 .../speech_dispatcher/speech_speech_dispatcher.c   |   29 +++++
 navit/navit/xpm/Makefile.am                        |  114 +++++++++++---------
 navit/navit/xpm/navit_svg2png                      |   12 ++-
 navit/po/de.po.in                                  |   18 +++-
 4 files changed, 120 insertions(+), 53 deletions(-)

diff --git a/navit/navit/speech/speech_dispatcher/speech_speech_dispatcher.c b/navit/navit/speech/speech_dispatcher/speech_speech_dispatcher.c
index 0522818..bef6e9c 100644
--- a/navit/navit/speech/speech_dispatcher/speech_speech_dispatcher.c
+++ b/navit/navit/speech/speech_dispatcher/speech_speech_dispatcher.c
@@ -27,6 +27,7 @@
 #include <glib.h>
 #include <stdarg.h>
 #include "config.h"
+#include "item.h"
 #include <libspeechd.h>
 #include "plugin.h"
 #include "speech.h"
@@ -59,6 +60,8 @@ static struct speech_methods speechd_meth = {
 static struct speech_priv *
 speechd_new(struct speech_methods *meth, struct attr **attrs, struct attr *attr) {
 	struct speech_priv *this;
+	struct attr *volume, *language;
+	char *lang_str;
 	SPDConnection *conn;
 
 	conn = spd_open("navit","main",NULL,SPD_MODE_SINGLE);
@@ -68,7 +71,33 @@ speechd_new(struct speech_methods *meth, struct attr **attrs, struct attr *attr)
 	if (this) {
 		this->conn=conn;
 		*meth=speechd_meth;
+		volume = attr_search(attrs, NULL, attr_data);
+		language = attr_search(attrs, NULL, attr_language);
+		if (language) {
+			lang_str=g_strdup(language->u.str);
+		} else {
+			char *lang_env=getenv("LANG");
+
+			if (lang_env) {
+				char *country,*lang,*lang_full;
+				lang_full=g_strdup(lang_env);
+				strtolower(lang_full,lang_env);
+				lang=g_strdup(lang_full);
+				country=strchr(lang_full,'_');
+				if (country) {
+					lang[country-lang_full]='\0';
+					*country++='-';
+				}
+				lang_str=g_strdup(lang);
+				g_free(lang_full);
+				g_free(lang);
+			}
+		}
 		spd_set_punctuation(conn, SPD_PUNCT_NONE);
+		spd_set_volume(conn, volume->u.num);
+		spd_set_language(conn, lang_str);
+		if (lang_str)
+			g_free(lang_str);
 	}
 	return this;
 }
diff --git a/navit/navit/xpm/Makefile.am b/navit/navit/xpm/Makefile.am
index 4dd5507..0846675 100644
--- a/navit/navit/xpm/Makefile.am
+++ b/navit/navit/xpm/Makefile.am
@@ -1,54 +1,61 @@
 include $(top_srcdir)/Makefile.inc
 
-xpm_DATA = bench.xpm
-xpm_DATA += biergarten.xpm
-xpm_DATA += boundary_stone.xpm
-xpm_DATA += bus_halt.xpm
-xpm_DATA += car_dealer.xpm
-xpm_DATA += castle.xpm
-xpm_DATA += ruins.xpm
-xpm_DATA += cemetery.xpm
-xpm_DATA += dumping_station.xpm
-xpm_DATA += fountain.xpm
-xpm_DATA += flag_bk_tr.xpm flag_bk_wh.xpm flag_bl_wh.xpm flag_wh_bk.xpm
-xpm_DATA += golf.xpm
-xpm_DATA += gc_tradi.xpm
-xpm_DATA += gc_multi.xpm
-xpm_DATA += gc_mystery.xpm
-xpm_DATA += gc_event.xpm
-xpm_DATA += gc_reference.xpm
-xpm_DATA += gc_webcam.xpm
-xpm_DATA += gc_question.xpm
-xpm_DATA += gc_stages.xpm
-xpm_DATA += highway_exit.xpm
-xpm_DATA += hunting_stand.xpm
-xpm_DATA += justice.xpm
-xpm_DATA += level_crossing.xpm
-xpm_DATA += library.xpm
-xpm_DATA += memorial.xpm
-xpm_DATA += military.xpm
-xpm_DATA += nav_left_1.xpm nav_left_2.xpm
-xpm_DATA += nav_right_1.xpm nav_right_2.xpm
-xpm_DATA += nav_straight.xpm nav_straight_32.xpm
-xpm_DATA += nav_left_1_32.xpm nav_left_2_32.xpm
-xpm_DATA += nav_right_1_32.xpm nav_right_2_32.xpm
-xpm_DATA += picnic.xpm
-xpm_DATA += potable_water.xpm
-xpm_DATA += restroom.xpm
-xpm_DATA += shelter.xpm
-xpm_DATA += skiing.xpm
-xpm_DATA += sport.xpm
-xpm_DATA += swimming.xpm
-xpm_DATA += theater.xpm
-xpm_DATA += toilets.xpm
-xpm_DATA += tower.xpm
-xpm_DATA += townhall.xpm
-xpm_DATA += trailerpark.xpm
-xpm_DATA += unknown.xpm
-xpm_DATA += wifi.xpm
-xpm_DATA += toggle_fullscreen.xpm
-xpm_DATA += menu.xpm
-xpm_DATA += public_office.xpm
+xpms = bench.xpm
+xpms += biergarten.xpm
+xpms += boundary_stone.xpm
+xpms += bus_halt.xpm
+xpms += car_dealer.xpm
+xpms += castle.xpm
+xpms += ruins.xpm
+xpms += cemetery.xpm
+#xpms += cursor.xpm
+xpms += dumping_station.xpm
+xpms += fountain.xpm
+xpms += flag_bk_tr.xpm flag_bk_wh.xpm flag_bl_wh.xpm flag_wh_bk.xpm
+xpms += golf.xpm
+xpms += gc_tradi.xpm
+xpms += gc_multi.xpm
+xpms += gc_mystery.xpm
+xpms += gc_event.xpm
+xpms += gc_reference.xpm
+xpms += gc_webcam.xpm
+xpms += gc_question.xpm
+xpms += gc_stages.xpm
+#xpms += heliport.xpm
+xpms += highway_exit.xpm
+xpms += hunting_stand.xpm
+xpms += justice.xpm
+xpms += level_crossing.xpm
+xpms += library.xpm
+xpms += mark.xpm
+xpms += memorial.xpm
+xpms += military.xpm
+#xpms += nav_left_1.xpm nav_left_2.xpm
+#xpms += nav_right_1.xpm nav_right_2.xpm
+#xpms += nav_straight.xpm nav_straight_32.xpm
+#xpms += nav_left_1_32.xpm nav_left_2_32.xpm
+#xpms += nav_right_1_32.xpm nav_right_2_32.xpm
+xpms += picnic.xpm
+xpms += potable_water.xpm
+xpms += restroom.xpm
+xpms += shelter.xpm
+xpms += skiing.xpm
+xpms += sport.xpm
+xpms += swimming.xpm
+xpms += theater.xpm
+xpms += toilets.xpm
+xpms += tower.xpm
+xpms += townhall.xpm
+xpms += trailerpark.xpm
+xpms += unknown.xpm
+xpms += wifi.xpm
+xpms += viewpoint.xpm
+xpms += zoo.xpm
+xpms += zoom_in.xpm
+xpms += zoom_out.xpm
+xpms += toggle_fullscreen.xpm
+xpms += menu.xpm
+xpms += public_office.xpm
 
 svgs  = gui_about.svg
 svgs += gui_actions.svg
@@ -183,6 +190,8 @@ flag_svgs += country_TZ.svgz country_UA.svgz country_UG.svgz country_UM.svgz cou
 flag_svgs += country_VA.svgz country_VC.svgz country_VE.svgz country_VG.svgz country_VI.svgz country_VN.svgz country_VU.svgz
 flag_svgs += country_WF.svgz country_WS.svgz country_YE.svgz country_YT.svgz country_ZA.svgz country_ZM.svgz country_ZW.svgz
 
+xpm_DATA=
+
 if USE_SVG
   xpm_DATA += $(svgs) $(nav_svgs) $(flag_svgs)
 endif
@@ -192,8 +201,10 @@ if USE_SVG2PNG
 	SRCDIR=$(abs_srcdir) BUILDDIR=$(abs_builddir) $(srcdir)/navit_svg2png "@SVG2PNG@" "$@"
 %.png: $(srcdir)/*.svg
 	SRCDIR=$(abs_srcdir) BUILDDIR=$(abs_builddir) $(srcdir)/navit_svg2png "@SVG2PNG@" "$@"
+%.png: $(srcdir)/*.xpm
+	SRCDIR=$(abs_srcdir) BUILDDIR=$(abs_builddir) $(srcdir)/navit_svg2png "@SVG2PNG@" "$@"
 
-pngs  = $(addsuffix .png,$(basename $(svgs)))
+pngs  = $(addsuffix .png,$(basename $(svgs))) $(addsuffix .png,$(basename $(xpms)))
 xsize = $(word 1,$(subst x, ,$(scale)))
 ysize = $(word $(words $(scale)),$(subst x, ,$(scale)))
 comma =,
@@ -211,8 +222,11 @@ if USE_SVG2PNG_SCALES_NAV
 pngs += $(foreach scale, $(subst $(comma), ,@SVG2PNG_SCALES_NAV@), $(addsuffix _$(xsize)_$(ysize).png,$(basename $(nav_svgs))))
 endif
 xpm_DATA += $(pngs)
+else
+xpm_DATA += $(xpms)
 endif
 
+
 if !SUPPORT_WIN32
   DESKTOPFILEdir=$(datadir)/applications
   DESKTOPFILE_DATA = desktop_icons/navit.desktop
diff --git a/navit/navit/xpm/navit_svg2png b/navit/navit/xpm/navit_svg2png
index 16ecfb7..ba76d7a 100755
--- a/navit/navit/xpm/navit_svg2png
+++ b/navit/navit/xpm/navit_svg2png
@@ -13,7 +13,7 @@ svgtopng()
 		$svgtopng --without-gui --export-width=$1 --export-height=$2 --export-png=$BUILDDIR/$4 $3
 		;;
 	*convert)
-		$svgtopng $3 -resize $1x$2 $4
+		$svgtopng -background none $3 -resize $1x$2 $4
 		;;
 	esac
 }
@@ -36,7 +36,7 @@ case "$png" in
 		svg=${png%.png}
 		;;
 esac
-if [ ! -f $svg.svg -a ! -f $svg.svgz ]
+if [ ! -f $svg.svg -a ! -f $svg.svgz -a ! -f $svg.xpm ]
 then
 	svg="$SRCDIR/$svg"
 fi
@@ -69,6 +69,14 @@ else
 		fi
 		svgtopng $w $h $svg.svg $png
 		rm -f $svg.svg
+	elif [ -f $svg.xpm ]
+	then
+		echo "w:$w h:$h"
+		if [ -z "$w" -a -z "$h" ]; then
+			convert -background none $svg.xpm $png
+		else
+			convert -background none $svg.xpm -resize ${w}x${h} $png
+		fi
 	fi
 fi
 exit 0
diff --git a/navit/po/de.po.in b/navit/po/de.po.in
index 98fd51b..dee51c7 100644
--- a/navit/po/de.po.in
+++ b/navit/po/de.po.in
@@ -1383,7 +1383,9 @@ msgid "Show/hide route description"
 msgstr "Routenbeschreibung anzeigen/schließen"
 
 msgid "Autozoom"
-msgstr "automatischer Zoom"
+msgstr ""
+"automatischer\n"
+"Zoom"
 
 msgid "Enable/disable automatic zoom level changing"
 msgstr "Automatischen Zoom einschalten/ausschalten"
@@ -1628,6 +1630,20 @@ msgstr ""
 "Navigation\n"
 "beenden"
 
+msgid ""
+"Map follows\n"
+"Vehicle"
+msgsrt ""
+"Karte folgt\n"
+"Fahrzeug"
+
+msgid ""
+"Lock on\n"
+"Road"
+msgstr ""
+"Auf Straße\n"
+"zeigen"
+
 msgid "Window Mode"
 msgstr "Fenstermodus"
 
-- 
1.7.4.1

