#!/bin/sh -e

umask 0000

APP_ID=org.webosinternals.navit
APP_DIR=/media/cryptofs/apps/usr/palm/applications/$APP_ID
NAVIT_USER_DATADIR=/media/internal/appdata/$APP_ID
#CERT_STORE=/etc/ssl/certs/appsigning-bundle.crt
#CRT=$APP_DIR/package-sig.crt

mkdir -p $NAVIT_USER_DATADIR/maps

# Check if there where any mods to the old files and remove them if not
LEGACY_FILES="navit_layout.xml navit_vehicleprofile.xml
	navit_gui_PreNav.xml navit_gui_pre.xml navit_gui.xml"
result=$(
 for f in navit.xml $LEGACY_FILES
 do
	 d=$NAVIT_USER_DATADIR/$f

	 if [ -e ${d} -a -e ${d}.md5sum ] && md5sum -c "${d}.md5sum" >/dev/null
	 then
		 echo -n "1"
	 elif [ -e ${d} -a ! -e ${d}.md5sum ]
	 then
		 echo -n "1"
	 elif [ ! -e ${d} ]
	 then
		 echo -n "1"
	 else
		 echo -n "0"
	 fi
 done
)

if [ $result == "111111" ]
then
	for f in $LEGACY_FILES
	do
		mv $NAVIT_USER_DATADIR/$f $NAVIT_USER_DATADIR/$f.old
		rm -f $NAVIT_USER_DATADIR/$f.new
		rm -f $NAVIT_USER_DATADIR/$f.md5sum
	done
fi
###

(cd $APP_DIR/dist_files/; find) | while read l
do
	s="$APP_DIR/dist_files/${l}"
	d="$NAVIT_USER_DATADIR/${l}"

	if [ -d "${s}" ]
 	then
		test ! -d "${d}" && mkdir -p "${d}"
	else
		if [ ! -f "${d}.md5sum" ]
		then
			cp "${s}" "${d}"
			md5sum "${d}" > "${d}.md5sum"
		
		elif md5sum -c "${d}.md5sum"
		then
			old_md5=$(cut -d ' ' -f 1 "${d}.md5sum")
			new_md5=$(md5sum ${s} | cut -d ' ' -f 1)
			if [ $old_md5 != $new_md5 ]
			then
				mv "${d}" "${d}.old"
				cp "${s}" "${d}"
				md5sum "${d}" > "${d}.md5sum"
			fi
		else
			cp "${s}" "${d}.new"
		fi
	fi
done

# Make jailer trust our jail_app.conf
#SUBJECT=$(openssl x509 -in $CRT -text | grep " \+Subject:" | sed -re 's/.*Subject//' -e 's/[:,] /\//g')
#if ! grep -q "subject= $SUBJECT" $CERT_STORE
#then
#	(echo "subject= $SUBJECT"
#	 echo "================================================"
#	 cat $CRT
#	) >> $CERT_STORE
#fi

